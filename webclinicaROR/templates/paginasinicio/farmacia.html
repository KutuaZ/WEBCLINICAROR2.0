{% extends "paginasinicio/base.html" %}
{% load static %}
{% load currency_filters %}

{% block content %}
<link rel="stylesheet" href="{% static '/css/Farmacia.css' %}">

<div class="farmacia-container">
    <!-- Barra de conversión para extranjeros -->
    {% if indicadores %}
    <div class="alert alert-info conversion-alert" id="conversion-info" style="display: none;">
        <div class="container">
            <h5><i class="fas fa-globe"></i> Conversión de Precios para Pacientes Extranjeros</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="currency-card p-3 bg-white rounded border">
                        <h6><i class="fas fa-dollar-sign text-success me-2"></i>Dólar Estadounidense (USD)</h6>
                        <p class="mb-1"><strong>1 USD = ${{ indicadores.dolar.valor|floatformat:0 }} CLP</strong></p>
                        <small class="text-muted">Actualizado: {{ indicadores.dolar.fecha|date:"d/m/Y" }}</small>
                        <div class="mt-2">
                            <small class="text-info">
                                <i class="fas fa-info-circle me-1"></i>
                                Ejemplo: Producto de $10.000 CLP = ${{ 10000|div:indicadores.dolar.valor|floatformat:1 }} USD
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="currency-card p-3 bg-white rounded border">
                        <h6><i class="fas fa-euro-sign text-primary me-2"></i>Euro (EUR)</h6>
                        <p class="mb-1"><strong>1 EUR = ${{ indicadores.euro.valor|floatformat:0 }} CLP</strong></p>
                        <small class="text-muted">Actualizado: {{ indicadores.euro.fecha|date:"d/m/Y" }}</small>
                        <div class="mt-2">
                            <small class="text-info">
                                <i class="fas fa-info-circle me-1"></i>
                                Ejemplo: Producto de $10.000 CLP = €{{ 10000|div:indicadores.euro.valor|floatformat:1 }} EUR
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-3 text-center">
                <small class="text-muted">
                    <i class="fas fa-shield-alt me-1"></i>
                    Tipos de cambio oficiales del Banco Central de Chile • 
                    <i class="fas fa-clock me-1"></i>
                    Se actualiza diariamente
                </small>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Barra de búsqueda con botón de conversión -->
    <nav class="navbar navbar-expand-lg navbar-secondary bg-white shadow-sm">
        <div class="container">
            <form class="d-flex mx-auto w-50" role="search">
                <input class="form-control me-2 rounded-pill" type="search" placeholder="Buscar productos..." aria-label="Search">
                <button class="btn btn-success rounded-pill px-4" type="submit">Buscar</button>
            </form>
            <ul class="navbar-nav ms-auto">
                {% if indicadores %}
                <li class="nav-item">
                    <button class="btn btn-outline-primary btn-sm me-2" id="toggle-conversion">
                        <i class="fas fa-exchange-alt"></i> ¿Eres extranjero?
                    </button>
                </li>
                {% endif %}
                <li class="nav-item">
                    <a class="nav-link position-relative" href="{% url 'ver_carrito' %}"> 
                        <img src="{% static '/assets/icon/carrito.png' %}" alt="Carrito">
                        <span id="carrito-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                            {{ request.session.carrito|length }} 
                        </span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <section class="productos-section py-5 bg-light">
        <div class="container">
            <h2 class="text-center mb-5 titulos3">Nuestros Productos</h2>
            
            {% if indicadores %}
            <!-- Información del servicio externo -->
            <div class="alert alert-success mb-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="mb-1"><i class="fas fa-check-circle"></i> Precios actualizados con tipos de cambio oficiales</h6>
                        <small>Datos obtenidos desde: <strong>MinIndicador.cl (Banco Central de Chile)</strong></small>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-info btn-sm" onclick="mostrarDetallesAPI()">
                            <i class="fas fa-info-circle"></i> Ver detalles del servicio
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div id="product-list" class="row g-4"> 
                {% for producto in productos %}
                <div class="col-md-4 producto" data-nombre="{{ producto.nombre }}">
                    <div class="producto-card shadow-sm rounded-4">
                        <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="producto-img rounded-top-4">
                        <div class="producto-info p-3">
                            <h4 class="producto-nombre">{{ producto.nombre }}</h4>
                            <p class="producto-desc">{{ producto.descripcion|truncatewords:15 }}</p>
                            
                            <!-- Precio en pesos chilenos -->
                            <div class="precio-principal">
                                <p class="producto-precio">{{ producto.precio|clp_format }}</p>
                            </div>
                            
                            <!-- Precios en otras monedas (oculto por defecto) -->
                            {% if indicadores %}
                            <div class="precios-conversion" style="display: none;">
                                <small class="text-muted">Equivalencias aproximadas:</small>
                                <div class="conversiones">
                                    <span class="badge badge-secondary me-1">
                                        USD: {{ producto.precio|to_usd:indicadores.dolar.valor }}
                                    </span>
                                    <span class="badge badge-secondary me-1">
                                        EUR: {{ producto.precio|to_eur:indicadores.euro.valor }}
                                    </span>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if producto.stock > 0 %}
                                <button class="btn btn-success btn-add" data-producto-id="{{ producto.id }}">Agregar al carrito</button>
                            {% else %}
                                <button class="btn btn-secondary" disabled>Sin Stock</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <p class="text-center">No hay productos disponibles en este momento.</p>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- Modal con información de la API -->
    <div class="modal fade" id="modalAPI" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-api"></i> Servicio Externo Integrado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>API de Indicadores Económicos</h6>
                    <p><strong>Proveedor:</strong> MinIndicador.cl (Banco Central de Chile)</p>
                    <p><strong>Función:</strong> Conversión de precios para pacientes extranjeros</p>
                    <p><strong>Actualización:</strong> Diaria (datos oficiales)</p>
                    <p><strong>Utilidad:</strong> Facilita compras de medicamentos a turistas médicos y residentes extranjeros</p>
                    {% if indicadores %}
                    <div class="alert alert-info">
                        <small><strong>Última actualización:</strong> {{ indicadores.fecha|date:"d/m/Y H:i" }}</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const csrftoken = '{{ csrf_token }}';
    
    // Toggle para mostrar/ocultar conversiones
    document.getElementById('toggle-conversion')?.addEventListener('click', function() {
        const conversionInfo = document.getElementById('conversion-info');
        const preciosConversion = document.querySelectorAll('.precios-conversion');
        
        if (conversionInfo.style.display === 'none') {
            conversionInfo.style.display = 'block';
            preciosConversion.forEach(el => el.style.display = 'block');
            this.innerHTML = '<i class="fas fa-times"></i> Ocultar conversión';
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-primary');
        } else {
            conversionInfo.style.display = 'none';
            preciosConversion.forEach(el => el.style.display = 'none');
            this.innerHTML = '<i class="fas fa-exchange-alt"></i> ¿Eres extranjero?';
            this.classList.remove('btn-primary');
            this.classList.add('btn-outline-primary');
        }
    });
    
    // Función para mostrar detalles de la API
    function mostrarDetallesAPI() {
        const modal = new bootstrap.Modal(document.getElementById('modalAPI'));
        modal.show();
    }
</script>
<script src="{% static '/js/farmacia.js' %}"></script>
{% endblock %}