{% extends "paginasinicio/base.html" %}
{% load static %}
{% load currency_filters %}

{% block content %}
<link rel="stylesheet" href="{% static '/css/Farmacia.css' %}">

{# ... (Barra de búsqueda secundaria) ... #}
<nav class="navbar navbar-expand-lg navbar-secondary bg-white shadow-sm mt-5">
    <div class="container">
        <form class="d-flex mx-auto w-50" role="search">
            <input class="form-control me-2 rounded-pill" type="search" placeholder="Buscar productos..." aria-label="Search">
            <button class="btn btn-success rounded-pill px-4" type="submit">Buscar</button>
        </form>
        <ul class="navbar-nav ms-auto">
            <li class="nav-item">
                <a class="nav-link position-relative" href="{% url 'ver_carrito' %}"> {# <-- CAMBIO: Enlace directo al carrito #}
                    <img src="{% static '/assets/icon/carrito.png' %}" alt="Carrito">
                    <span id="carrito-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        {{ request.session.carrito|length }} {# <-- Muestra la cantidad de items en el carrito #}
                    </span>
                </a>
            </li>
        </ul>
    </div>
</nav>

{# SE ELIMINA EL OFFCANVAS DE AQUÍ PORQUE AHORA TENEMOS UNA PÁGINA DEDICADA #}

<section class="productos-section py-5 bg-light">
    <div class="container">
        <h2 class="text-center mb-5 titulos3">Nuestros Productos</h2>
        <div id="product-list" class="row g-4"> {# <-- Añadimos un ID para el contenedor de productos #}

            {% for producto in productos %}
            <div class="col-md-4 producto" data-nombre="{{ producto.nombre }}">
                <div class="producto-card shadow-sm rounded-4">
                    <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="producto-img rounded-top-4">
                    <div class="producto-info p-3">
                        <h4 class="producto-nombre">{{ producto.nombre }}</h4>
                        <p class="producto-desc">{{ producto.descripcion|truncatewords:15 }}</p>
                        <p class="producto-precio">{{ producto.precio|clp_format }}</p>
                        
                        {# --- CAMBIO IMPORTANTE --- #}
                        {# Añadimos el ID del producto al botón y restringimos si no hay stock #}
                        {% if producto.stock > 0 %}
                            <button class="btn btn-success btn-add" data-producto-id="{{ producto.id }}">Agregar al carrito</button>
                        {% else %}
                            <button class="btn btn-secondary" disabled>Sin Stock</button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-center">No hay productos disponibles en este momento.</p>
            {% endfor %}
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
{# Necesitamos el token CSRF para las peticiones seguras #}
<script>
    const csrftoken = '{{ csrf_token }}';
</script>
<script src="{% static '/js/farmacia.js' %}"></script>
{% endblock %}